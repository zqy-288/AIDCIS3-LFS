"""
Â≠î‰ΩçËßÜÂõæËøáÊª§Âô®Êèí‰ª∂
Âü∫‰∫éAI-1Êèí‰ª∂ÂåñÊû∂ÊûÑÂíåAI-2 UIÁªÑ‰ª∂Á≥ªÁªüÂÆûÁé∞ÁöÑËßÜÂõæËøáÊª§ÂäüËÉΩ
"""

from typing import Optional, Dict, Any, List, Callable
from PySide6.QtWidgets import (QWidget, QVBoxLayout, QHBoxLayout, QComboBox, 
                               QLabel, QPushButton, QFrame, QSpacerItem, QSizePolicy)
from PySide6.QtCore import Qt, Signal, QTimer
from PySide6.QtGui import QFont, QIcon
from enum import Enum
import time

# Âü∫Á°ÄÊû∂ÊûÑÂØºÂÖ•
from src.core.interfaces.plugin_interfaces import IUIPlugin, PluginMetadata, PluginVersion
from src.core.dependency_injection import injectable, ServiceLifetime, get_container
from src.modules.ui_component_base import UIComponentBase, ui_component

# ‰∏öÂä°ÈÄªËæëÂØºÂÖ•
from src.core_business.models.hole_data import HoleData, HoleCollection, HoleStatus
from src.core_business.data_adapter import DataAdapter
from src.core_business.business_cache import BusinessCacheManager, cached_business_operation
from src.core_business.business_rules import BusinessRuleEngine


class ViewFilterType(Enum):
    """ËßÜÂõæËøáÊª§Âô®Á±ªÂûã"""
    ALL = "all"                    # ÂÖ®ÈÉ®Â≠î‰Ωç
    PENDING = "pending"            # ÂæÖÊ£ÄÂ≠î‰Ωç
    QUALIFIED = "qualified"        # ÂêàÊ†ºÂ≠î‰Ωç
    DEFECTIVE = "defective"        # ÂºÇÂ∏∏Â≠î‰Ωç
    BLIND = "blind"                # Áõ≤Â≠î
    TIE_ROD = "tie_rod"           # ÊãâÊùÜÂ≠î
    PROCESSING = "processing"      # Ê£ÄÊµã‰∏≠


@ui_component(name="HoleViewFilter", dependencies=["DataAdapter", "BusinessCacheManager"])
@injectable(ServiceLifetime.SINGLETON)
class HoleViewFilterComponent(UIComponentBase):
    """Â≠î‰ΩçËßÜÂõæËøáÊª§Âô®ÁªÑ‰ª∂"""
    
    # ‰ø°Âè∑ÂÆö‰πâ
    filter_changed = Signal(str, list)  # ËøáÊª§Âô®ÊîπÂèò‰ø°Âè∑ (filter_type, filtered_holes)
    status_updated = Signal(dict)       # Áä∂ÊÄÅÊõ¥Êñ∞‰ø°Âè∑
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setObjectName("HoleViewFilterComponent")
        
        # Â£∞Êòé‰æùËµñ
        self.declare_dependency("data_adapter", DataAdapter)
        self.declare_dependency("cache_manager", BusinessCacheManager)
        self.declare_dependency("rule_engine", BusinessRuleEngine, required=False)
        
        # ÁªÑ‰ª∂Áä∂ÊÄÅ
        self.current_filter = ViewFilterType.ALL
        self.hole_collection: Optional[HoleCollection] = None
        self.filtered_holes: List[HoleData] = []
        self.filter_stats: Dict[str, int] = {}
        
        # ÊÄßËÉΩÁõëÊéß
        self.last_filter_time = 0.0
        self.filter_count = 0
        
        # UIÁªÑ‰ª∂
        self.widget: Optional[QWidget] = None
        self.filter_combo: Optional[QComboBox] = None
        self.status_label: Optional[QLabel] = None
        self.refresh_button: Optional[QPushButton] = None
        
        # Âª∂ËøüÊõ¥Êñ∞ËÆ°Êó∂Âô®
        self.update_timer = QTimer()
        self.update_timer.timeout.connect(self._apply_filter)
        self.update_timer.setSingleShot(True)
    
    def _do_initialize(self) -> bool:
        """ÂàùÂßãÂåñÁªÑ‰ª∂"""
        try:
            # Ëé∑Âèñ‰æùËµñ
            self.data_adapter = self.get_dependency("data_adapter")
            self.cache_manager = self.get_dependency("cache_manager")
            self.rule_engine = self.get_dependency("rule_engine")
            
            # ÂàõÂª∫UI
            self._create_ui()
            
            # ÂàùÂßãÂåñËøáÊª§Âô®ÈÄâÈ°π
            self._setup_filter_options()
            
            # ËøûÊé•‰ø°Âè∑
            self._connect_signals()
            
            print(f"‚úÖ Â≠î‰ΩçËßÜÂõæËøáÊª§Âô®ÁªÑ‰ª∂ÂàùÂßãÂåñÂÆåÊàê: {self.component_id}")
            return True
            
        except Exception as e:
            print(f"‚ùå Â≠î‰ΩçËßÜÂõæËøáÊª§Âô®ÁªÑ‰ª∂ÂàùÂßãÂåñÂ§±Ë¥•: {self.component_id} -> {e}")
            return False
    
    def _create_ui(self):
        """ÂàõÂª∫Áî®Êà∑ÁïåÈù¢"""
        # ÂàõÂª∫‰∏ªwidget
        self.widget = QWidget()
        self.widget.setObjectName("HoleViewFilterWidget")
        
        # ‰∏ªÂ∏ÉÂ±Ä - ‰ΩøÁî®Ê∞¥Âπ≥Â∏ÉÂ±Ä‰ª•ÈÄÇÂ∫îÈ°∂ÈÉ®‰ΩçÁΩÆ
        main_layout = QHBoxLayout()
        self.widget.setLayout(main_layout)
        main_layout.setContentsMargins(10, 5, 10, 5)
        main_layout.setSpacing(15)
        
        # ËøáÊª§Âô®ÊéßÂà∂Âå∫Âüü
        filter_frame = QFrame()
        filter_frame.setFrameStyle(QFrame.Box)
        filter_frame.setLineWidth(1)
        filter_layout = QHBoxLayout(filter_frame)
        filter_layout.setContentsMargins(8, 4, 8, 4)
        
        # ËßÜÂõæÊ†áÁ≠æ
        view_label = QLabel("ËßÜÂõæ:")
        view_label.setMinimumWidth(40)
        filter_layout.addWidget(view_label)
        
        # ËøáÊª§Âô®‰∏ãÊãâÊ°Ü
        self.filter_combo = QComboBox()
        self.filter_combo.setMinimumWidth(120)
        self.filter_combo.setMaximumWidth(180)
        filter_layout.addWidget(self.filter_combo)
        
        # Áä∂ÊÄÅÊ†áÁ≠æ
        self.status_label = QLabel("Áä∂ÊÄÅ: Â∞±Áª™")
        self.status_label.setStyleSheet("color: #666;")
        filter_layout.addWidget(self.status_label)
        
        # Âà∑Êñ∞ÊåâÈíÆ
        self.refresh_button = QPushButton("Âà∑Êñ∞")
        self.refresh_button.setMaximumWidth(60)
        filter_layout.addWidget(self.refresh_button)
        
        main_layout.addWidget(filter_frame)
        
        # ÁªüËÆ°‰ø°ÊÅØÂå∫Âüü - Ê∞¥Âπ≥Â∏ÉÂ±Ä
        stats_frame = QFrame()
        stats_frame.setFrameStyle(QFrame.Box)
        stats_frame.setLineWidth(1)
        stats_layout = QHBoxLayout(stats_frame)
        stats_layout.setContentsMargins(8, 4, 8, 4)
        
        # ÁªüËÆ°Ê†áÁ≠æ
        self.stats_labels = {}
        for filter_type in ViewFilterType:
            if filter_type == ViewFilterType.ALL:
                continue
            label = QLabel(f"{self._get_filter_display_name(filter_type)}: 0")
            label.setStyleSheet("color: #333; font-size: 10px;")
            stats_layout.addWidget(label)
            self.stats_labels[filter_type.value] = label
        
        main_layout.addWidget(stats_frame)
        
        # Ê∑ªÂä†ÂºπÊÄßÁ©∫Èó¥
        main_layout.addItem(QSpacerItem(40, 20, QSizePolicy.Expanding, QSizePolicy.Minimum))
        
        # ËÆæÁΩÆwidgetÁöÑÊúÄÂ§ßÈ´òÂ∫¶‰ª•ÈÄÇÂ∫îÈ°∂ÈÉ®‰ΩçÁΩÆ
        self.widget.setMaximumHeight(60)
        
        # ËÆæÁΩÆÊï¥‰ΩìÊ†∑Âºè
        self.widget.setStyleSheet("""
            QFrame {
                background-color: #f8f9fa;
                border-radius: 4px;
            }
            QComboBox {
                padding: 4px 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
                background-color: white;
            }
            QComboBox:hover {
                border-color: #007bff;
            }
            QComboBox::drop-down {
                border: none;
                width: 20px;
            }
            QComboBox::down-arrow {
                image: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAiIGhlaWdodD0iNiIgdmlld0JveD0iMCAwIDEwIDYiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxwYXRoIGQ9Ik0xIDFMNSA1TDkgMSIgc3Ryb2tlPSIjNjY2IiBzdHJva2Utd2lkdGg9IjEuNSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo=);
            }
            QPushButton {
                padding: 4px 12px;
                border: 1px solid #007bff;
                border-radius: 4px;
                background-color: #007bff;
                color: white;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #0056b3;
            }
            QPushButton:pressed {
                background-color: #004085;
            }
        """)
    
    def _setup_filter_options(self):
        """ËÆæÁΩÆËøáÊª§Âô®ÈÄâÈ°π"""
        # Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
        self.filter_combo.clear()
        
        # Ê∑ªÂä†ËøáÊª§Âô®ÈÄâÈ°π
        filter_options = [
            (ViewFilterType.ALL, "ÂÖ®ÈÉ®Â≠î‰Ωç"),
            (ViewFilterType.PENDING, "ÂæÖÊ£ÄÂ≠î‰Ωç"),
            (ViewFilterType.QUALIFIED, "ÂêàÊ†ºÂ≠î‰Ωç"),
            (ViewFilterType.DEFECTIVE, "ÂºÇÂ∏∏Â≠î‰Ωç"),
            (ViewFilterType.BLIND, "Áõ≤Â≠î"),
            (ViewFilterType.TIE_ROD, "ÊãâÊùÜÂ≠î"),
            (ViewFilterType.PROCESSING, "Ê£ÄÊµã‰∏≠")
        ]
        
        for filter_type, display_name in filter_options:
            self.filter_combo.addItem(display_name, filter_type)
        
        # ËÆæÁΩÆÈªòËÆ§ÈÄâÊã©
        self.filter_combo.setCurrentIndex(0)
    
    def _connect_signals(self):
        """ËøûÊé•‰ø°Âè∑"""
        # ËøáÊª§Âô®ÊîπÂèò
        self.filter_combo.currentIndexChanged.connect(self._on_filter_changed)
        
        # Âà∑Êñ∞ÊåâÈíÆ
        self.refresh_button.clicked.connect(self.refresh_data)
    
    def _get_filter_display_name(self, filter_type: ViewFilterType) -> str:
        """Ëé∑ÂèñËøáÊª§Âô®ÊòæÁ§∫ÂêçÁß∞"""
        display_names = {
            ViewFilterType.ALL: "ÂÖ®ÈÉ®Â≠î‰Ωç",
            ViewFilterType.PENDING: "ÂæÖÊ£ÄÂ≠î‰Ωç",
            ViewFilterType.QUALIFIED: "ÂêàÊ†ºÂ≠î‰Ωç",
            ViewFilterType.DEFECTIVE: "ÂºÇÂ∏∏Â≠î‰Ωç",
            ViewFilterType.BLIND: "Áõ≤Â≠î",
            ViewFilterType.TIE_ROD: "ÊãâÊùÜÂ≠î",
            ViewFilterType.PROCESSING: "Ê£ÄÊµã‰∏≠"
        }
        return display_names.get(filter_type, filter_type.value)
    
    def _on_filter_changed(self, index: int):
        """ËøáÊª§Âô®ÊîπÂèòÂ§ÑÁêÜ"""
        if self.filter_combo is None:
            return
        
        filter_type = self.filter_combo.itemData(index)
        if filter_type != self.current_filter:
            self.current_filter = filter_type
            print(f"üîÑ ËøáÊª§Âô®ÊîπÂèò‰∏∫: {filter_type.value}")
            
            # Âª∂ËøüÂ∫îÁî®ËøáÊª§Âô®ÔºàÈÅøÂÖçÈ¢ëÁπÅÊõ¥Êñ∞Ôºâ
            self.update_timer.start(50)  # 50msÂª∂Ëøü
    
    def _apply_filter(self):
        """Â∫îÁî®ËøáÊª§Âô®"""
        if not self.hole_collection:
            return
        
        start_time = time.time()
        
        try:
            # Êõ¥Êñ∞Áä∂ÊÄÅ
            self.status_label.setText("Áä∂ÊÄÅ: ËøáÊª§‰∏≠...")
            
            # Â∫îÁî®ËøáÊª§ÈÄªËæë
            if self.current_filter == ViewFilterType.ALL:
                self.filtered_holes = list(self.hole_collection.holes.values())
            else:
                # ËΩ¨Êç¢ËøáÊª§Âô®Á±ªÂûãÂà∞HoleStatus
                status_mapping = {
                    ViewFilterType.PENDING: HoleStatus.PENDING,
                    ViewFilterType.QUALIFIED: HoleStatus.QUALIFIED,
                    ViewFilterType.DEFECTIVE: HoleStatus.DEFECTIVE,
                    ViewFilterType.BLIND: HoleStatus.BLIND,
                    ViewFilterType.TIE_ROD: HoleStatus.TIE_ROD,
                    ViewFilterType.PROCESSING: HoleStatus.PROCESSING
                }
                
                target_status = status_mapping.get(self.current_filter)
                if target_status:
                    self.filtered_holes = self.hole_collection.get_holes_by_status(target_status)
                else:
                    self.filtered_holes = []
            
            # ËÆ°ÁÆóËøáÊª§Êó∂Èó¥
            filter_time = (time.time() - start_time) * 1000  # ÊØ´Áßí
            self.last_filter_time = filter_time
            self.filter_count += 1
            
            # Êõ¥Êñ∞Áä∂ÊÄÅ
            self.status_label.setText(f"Áä∂ÊÄÅ: Â∑≤ËøáÊª§ {len(self.filtered_holes)} ‰∏™Â≠î‰Ωç ({filter_time:.1f}ms)")
            
            # ÂèëÈÄÅËøáÊª§ÁªìÊûú‰ø°Âè∑
            self.filter_changed.emit(self.current_filter.value, self.filtered_holes)
            
            # Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
            self._update_statistics()
            
            print(f"‚úÖ ËøáÊª§ÂÆåÊàê: {self.current_filter.value}, ÁªìÊûú: {len(self.filtered_holes)} ‰∏™Â≠î‰Ωç, ËÄóÊó∂: {filter_time:.1f}ms")
            
        except Exception as e:
            print(f"‚ùå ËøáÊª§Âô®Â∫îÁî®Â§±Ë¥•: {e}")
            self.status_label.setText("Áä∂ÊÄÅ: ËøáÊª§Â§±Ë¥•")
    
    def _update_statistics(self):
        """Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ"""
        if not self.hole_collection:
            return
        
        # ËÆ°ÁÆóÂêÑÁä∂ÊÄÅÁöÑÁªüËÆ°Êï∞ÊçÆ
        status_counts = self.hole_collection.get_status_counts()
        
        # Êõ¥Êñ∞ÁªüËÆ°Ê†áÁ≠æ
        status_mapping = {
            HoleStatus.PENDING: "pending",
            HoleStatus.QUALIFIED: "qualified",
            HoleStatus.DEFECTIVE: "defective",
            HoleStatus.BLIND: "blind",
            HoleStatus.TIE_ROD: "tie_rod",
            HoleStatus.PROCESSING: "processing"
        }
        
        for status, key in status_mapping.items():
            count = status_counts.get(status, 0)
            if key in self.stats_labels:
                filter_type = ViewFilterType(key)
                display_name = self._get_filter_display_name(filter_type)
                self.stats_labels[key].setText(f"{display_name}: {count}")
        
        # ÂèëÈÄÅÁªüËÆ°‰ø°ÊÅØÊõ¥Êñ∞‰ø°Âè∑
        stats_dict = {key: status_counts.get(status, 0) for status, key in status_mapping.items()}
        stats_dict['total'] = len(self.hole_collection.holes)
        self.status_updated.emit(stats_dict)
    
    def set_hole_collection(self, hole_collection: HoleCollection):
        """ËÆæÁΩÆÂ≠î‰ΩçÈõÜÂêà"""
        self.hole_collection = hole_collection
        print(f"üìä ËÆæÁΩÆÂ≠î‰ΩçÈõÜÂêà: {len(hole_collection.holes) if hole_collection else 0} ‰∏™Â≠î‰Ωç")
        
        # ÈáçÊñ∞Â∫îÁî®ÂΩìÂâçËøáÊª§Âô®
        self._apply_filter()
    
    def refresh_data(self):
        """Âà∑Êñ∞Êï∞ÊçÆ"""
        print("üîÑ Âà∑Êñ∞ËøáÊª§Âô®Êï∞ÊçÆ")
        self.status_label.setText("Áä∂ÊÄÅ: Âà∑Êñ∞‰∏≠...")
        
        # Ê∏ÖÁ©∫ÁºìÂ≠ò
        if self.cache_manager:
            self.cache_manager.invalidate_pattern("hole_view_filter")
        
        # ÈáçÊñ∞Â∫îÁî®ËøáÊª§Âô®
        self._apply_filter()
    
    def get_filtered_holes(self) -> List[HoleData]:
        """Ëé∑ÂèñËøáÊª§ÂêéÁöÑÂ≠î‰ΩçÂàóË°®"""
        return self.filtered_holes.copy()
    
    def get_current_filter(self) -> ViewFilterType:
        """Ëé∑ÂèñÂΩìÂâçËøáÊª§Âô®Á±ªÂûã"""
        return self.current_filter
    
    def set_filter(self, filter_type: ViewFilterType):
        """ËÆæÁΩÆËøáÊª§Âô®Á±ªÂûã"""
        if filter_type != self.current_filter:
            for i in range(self.filter_combo.count()):
                if self.filter_combo.itemData(i) == filter_type:
                    self.filter_combo.setCurrentIndex(i)
                    break
    
    def get_performance_info(self) -> Dict[str, Any]:
        """Ëé∑ÂèñÊÄßËÉΩ‰ø°ÊÅØ"""
        return {
            'last_filter_time_ms': self.last_filter_time,
            'filter_count': self.filter_count,
            'average_filter_time_ms': self.last_filter_time / max(1, self.filter_count),
            'current_filter': self.current_filter.value,
            'filtered_count': len(self.filtered_holes),
            'total_count': len(self.hole_collection.holes) if self.hole_collection else 0
        }
    
    def get_widget(self) -> Optional[QWidget]:
        """Ëé∑ÂèñUI widget"""
        return self.widget
    
    def _do_cleanup(self):
        """Ê∏ÖÁêÜËµÑÊ∫ê"""
        # ÂÅúÊ≠¢ËÆ°Êó∂Âô®
        if self.update_timer.isActive():
            self.update_timer.stop()
        
        # Ê∏ÖÁ©∫Êï∞ÊçÆ
        self.hole_collection = None
        self.filtered_holes.clear()
        
        print(f"üßπ Â≠î‰ΩçËßÜÂõæËøáÊª§Âô®ÁªÑ‰ª∂Ê∏ÖÁêÜÂÆåÊàê: {self.component_id}")


@injectable(ServiceLifetime.SINGLETON)
class HoleViewFilterPlugin(IUIPlugin):
    """Â≠î‰ΩçËßÜÂõæËøáÊª§Âô®Êèí‰ª∂"""
    
    def __init__(self):
        self.metadata = PluginMetadata(
            id="hole_view_filter",
            name="HoleViewFilter",
            version=PluginVersion(1, 0, 0),
            description="Â≠î‰ΩçËßÜÂõæËøáÊª§Âô®Êèí‰ª∂ - ÊîØÊåÅÊåâÁä∂ÊÄÅËøáÊª§Â≠î‰ΩçÊòæÁ§∫",
            author="AIDCIS3-LFS Team",
            dependencies=["DataAdapter", "BusinessCacheManager"],
            tags=["ui", "filter", "hole_data"]
        )
        
        self.component: Optional[HoleViewFilterComponent] = None
        self.is_loaded = False
    
    def get_metadata(self) -> PluginMetadata:
        """Ëé∑ÂèñÊèí‰ª∂ÂÖÉÊï∞ÊçÆ"""
        return self.metadata
    
    def initialize(self, config: Dict[str, Any] = None) -> bool:
        """ÂàùÂßãÂåñÊèí‰ª∂"""
        try:
            # ÂàõÂª∫UIÁªÑ‰ª∂
            self.component = HoleViewFilterComponent()
            
            # ÂàùÂßãÂåñÁªÑ‰ª∂
            if self.component.initialize():
                self.is_loaded = True
                return True
            else:
                return False
                
        except Exception as e:
            print(f"HoleViewFilterPluginÂàùÂßãÂåñÂ§±Ë¥•: {e}")
            return False
    
    def start(self) -> bool:
        """ÂêØÂä®Êèí‰ª∂"""
        if self.component and self.is_loaded:
            try:
                self.component.start()
                return True
            except Exception as e:
                print(f"HoleViewFilterPluginÂêØÂä®Â§±Ë¥•: {e}")
                return False
        return False
    
    def stop(self) -> bool:
        """ÂÅúÊ≠¢Êèí‰ª∂"""
        if self.component:
            try:
                self.component.stop()
                return True
            except Exception as e:
                print(f"HoleViewFilterPluginÂÅúÊ≠¢Â§±Ë¥•: {e}")
                return False
        return True
    
    def cleanup(self) -> bool:
        """Ê∏ÖÁêÜÊèí‰ª∂"""
        if self.component:
            try:
                self.component.cleanup()
                self.component = None
                self.is_loaded = False
                return True
            except Exception as e:
                print(f"HoleViewFilterPluginÊ∏ÖÁêÜÂ§±Ë¥•: {e}")
                return False
        return True
    
    def get_component(self) -> Optional[HoleViewFilterComponent]:
        """Ëé∑ÂèñUIÁªÑ‰ª∂"""
        return self.component
    
    def is_compatible(self, version: str) -> bool:
        """Ê£ÄÊü•ÁâàÊú¨ÂÖºÂÆπÊÄß"""
        return True  # ÁÆÄÂåñÂÆûÁé∞ÔºåÂÆûÈôÖÂ∫îËØ•Ê£ÄÊü•ÁâàÊú¨
    
    def get_required_permissions(self) -> List[str]:
        """Ëé∑ÂèñÊâÄÈúÄÊùÉÈôê"""
        return ["ui.create_widget", "data.read_holes"]
    
    def validate_configuration(self, config: Dict[str, Any]) -> bool:
        """È™åËØÅÈÖçÁΩÆ"""
        return True  # ÁÆÄÂåñÂÆûÁé∞
    
    def create_widget(self, parent=None):
        """ÂàõÂª∫UIÁªÑ‰ª∂"""
        if not self.component:
            return None
        widget = self.component.get_widget()
        if widget and parent:
            widget.setParent(parent)
        return widget
    
    def get_widget_info(self) -> Dict[str, Any]:
        """Ëé∑ÂèñÁªÑ‰ª∂‰ø°ÊÅØ"""
        return {
            'name': 'HoleViewFilter',
            'title': 'Â≠î‰ΩçËßÜÂõæËøáÊª§Âô®',
            'description': 'ÊîØÊåÅÊåâÁä∂ÊÄÅËøáÊª§Â≠î‰ΩçÊòæÁ§∫',
            'version': '1.0.0',
            'widget_type': 'filter_panel'
        }
    
    def handle_ui_event(self, event_type: str, data: Any) -> bool:
        """Â§ÑÁêÜUI‰∫ã‰ª∂"""
        if not self.component:
            return False
        
        if event_type == 'set_hole_collection':
            self.component.set_hole_collection(data)
            return True
        elif event_type == 'refresh':
            self.component.refresh_data()
            return True
        elif event_type == 'set_filter':
            self.component.set_filter(data)
            return True
        
        return False