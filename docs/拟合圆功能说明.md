# 3.1界面拟合圆功能实现说明

## 功能概述

已成功在3.1界面（光谱共焦历史数据查看器）中实现了基于matlab代码的拟合圆功能。当用户在【测量数据】表格中双击某一行时，系统会自动提取该行的通道1~3数据，进行拟合圆计算，并在右侧四个坐标图中显示详细的分析结果。

## 核心功能

### 1. 拟合圆算法 (ProbeCircleFitter)

基于matlab代码实现的探头拟合圆算法：

```python
# 核心算法参数
probe_r = 18.85        # 探头主圆半径 (mm)
probe_small_r = 4      # 子探头小圆半径 (mm)
theta_list = [0, 2π/3, 4π/3]  # 三个子探头方向角度

# 输入: 三个通道的测量值 [channel1, channel2, channel3]
# 输出: 拟合圆心坐标、直径、半径等完整信息
```

### 2. 双击事件处理

- **触发方式**: 在测量数据表格中双击任意行
- **数据提取**: 自动提取该行的通道1值、通道2值、通道3值
- **数据验证**: 检查数据完整性和格式正确性
- **错误处理**: 提供友好的错误提示信息

### 3. 四个坐标图显示

#### 左上角 - 探头与待测圆示意图
- 探头主圆（蓝色虚线）
- 三个子探头小圆（蓝色实线）
- 径向测量线（灰色虚线）
- 测量段和测量点（黑色实线和点）
- 拟合的待测圆（红色实线）
- 圆心标注和说明文字

#### 右上角 - 拟合圆详细图
- 三个测量点的精确位置（蓝色散点）
- 拟合圆（红色实线）
- 拟合圆心（红色圆点）
- 圆心到测量点的连线（绿色虚线）
- 拟合信息文本框

#### 左下角 - 测量分析图
- 三个通道的测量值柱状图
- 不同颜色区分各通道
- 数值标签显示精确测量值
- 平均值线和标准差范围
- 角度信息标注（0°, 120°, 240°）

#### 右下角 - 拟合结果统计
- 拟合圆心坐标
- 拟合圆直径和半径
- 探头参数信息
- 各通道测量值详情
- 统计分析（平均值、标准差、范围）
- 圆心偏移量分析
- 拟合质量评估

## 使用方法

### 1. 数据查询
1. 在3.1界面选择工件ID
2. 输入孔ID（如：H001）
3. 点击【查询】按钮加载数据

### 2. 拟合圆分析
1. 在左侧【测量数据】表格中找到要分析的行
2. 双击该行的任意位置
3. 系统自动提取通道1~3数据
4. 右侧四个坐标图实时更新显示拟合结果

### 3. 结果解读
- **圆心偏移量**: 
  - < 0.1mm: 优秀
  - 0.1-0.2mm: 良好  
  - > 0.2mm: 需要关注
- **拟合质量**: 基于圆心偏移量自动评估
- **测量一致性**: 通过标准差分析各通道数据的一致性

## 技术实现

### 1. 算法验证
- 使用matlab示例数据验证算法正确性
- 输入: [0.602859, 0.12128, 0.251894]
- 输出: 圆心(0.2766, -0.0760), 直径38.3528mm
- 与matlab结果完全一致 ✓

### 2. 数据流程
```
CSV数据 → 表格显示 → 双击事件 → 数据提取 → 拟合计算 → 图表绘制
```

### 3. 错误处理
- 数据缺失检查
- 格式验证
- 拟合失败处理
- 用户友好的错误提示

## 测试验证

### 1. 算法测试
- ✅ matlab示例数据验证通过
- ✅ 多组测试数据验证通过
- ✅ 边界条件测试通过

### 2. 界面集成测试
- ✅ 双击事件正确触发
- ✅ 数据提取准确无误
- ✅ 图表显示正常
- ✅ 错误处理完善

### 3. 性能测试
- ✅ 计算速度快（毫秒级）
- ✅ 内存占用合理
- ✅ 界面响应流畅

## 扩展功能

### 1. 批量分析
可扩展支持选择多行数据进行批量拟合圆分析

### 2. 结果导出
可扩展支持将拟合结果导出为报告或图片

### 3. 历史对比
可扩展支持不同位置的拟合结果对比分析

### 4. 参数调整
可扩展支持用户自定义探头参数（probe_r, probe_small_r）

## 文件结构

```
history_viewer.py           # 主要实现文件
├── ProbeCircleFitter      # 拟合圆算法类
├── HistoryViewer          # 3.1界面主类
├── on_table_double_clicked # 双击事件处理
├── plot_probe_fitted_circles # 拟合圆绘制
├── plot_probe_diagram     # 探头示意图
├── plot_fitted_circle_detail # 拟合圆详细图
├── plot_measurement_analysis # 测量分析图
└── plot_probe_statistics  # 统计信息图

test_probe_fitting.py       # 算法验证测试
simple_test_fitting.py      # 简化功能测试
matlab.txt                  # 原始matlab代码参考
```

## 总结

✅ **功能完整**: 完全实现了基于matlab代码的拟合圆功能
✅ **界面友好**: 双击操作简单直观，四个图表信息丰富
✅ **算法准确**: 与matlab结果完全一致
✅ **错误处理**: 完善的异常处理和用户提示
✅ **性能优良**: 快速响应，流畅操作

用户现在可以在3.1界面中通过双击表格行来查看详细的拟合圆分析结果，包括探头示意图、拟合圆详情、测量分析和统计信息，为管孔检测提供了强大的数据分析工具。
