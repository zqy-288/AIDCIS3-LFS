# 实时监控界面UI修改说明

## 修改概述

根据您的要求，对二级【实时监控】界面进行了以下修改：

### 🎯 主要修改内容

1. **布局调整**：将面板A和面板B从左右布局改为上下布局（A在上，B在下）
2. **异常监控**：在面板A右侧新增异常直径显示小窗口
3. **样品切换**：添加【查看下一个样品】按钮（位于右侧面板）
4. **数据管理**：实现样品数据的保存和切换功能

## 详细修改说明

### 1. 布局结构调整

**修改前：**
```
[状态面板]
[面板A - 图表] | [面板B - 内窥镜]
[控制按钮]
```

**修改后：**
```
[状态面板]
[面板A - 图表 | 异常监控 + 切换按钮]
[面板B - 内窥镜]
[控制按钮]
```

### 2. 面板A结构重新设计

#### 左侧：图表区域
- **原有功能**：保持光谱共焦传感器实时折线图
- **布局调整**：图表占据面板A的主要区域

#### 右侧：异常监控和控制区域
- **异常直径监控小窗口**：
  - 实时显示超出公差的测量点
  - 显示内容：深度值、直径值、偏差值
  - 异常统计信息
  - 特性：固定宽度280px，滚动显示最近10个异常点
  - 红色文字突出显示异常数据
- **【查看下一个样品】按钮**：
  - 位于异常监控窗口下方
  - 绿色背景，醒目易用

### 3. 异常检测机制

#### 检测逻辑
```python
def check_anomaly(self, depth, diameter):
    deviation = abs(diameter - self.target_diameter)
    if deviation > self.tolerance:
        # 记录异常数据
        anomaly_info = {
            'depth': depth,
            'diameter': diameter,
            'deviation': deviation,
            'sample_id': self.current_hole_id
        }
        self.anomaly_data.append(anomaly_info)
```

#### 显示特性
- 自动检测超出公差范围的数据点
- 实时更新异常列表显示
- 显示异常点数和异常率统计
- 支持滚动查看历史异常数据

### 4. 样品管理功能

#### 数据结构
```python
self.sample_data_history = {
    'Sample_0': {
        'depths': [...],
        'diameters': [...],
        'anomalies': [...]
    },
    'Sample_1': {...},
    ...
}
```

#### 切换机制
1. **保存当前数据**：切换前自动保存当前样品的所有数据
2. **清除显示**：清除图表和异常显示
3. **加载新数据**：如果新样品有历史数据则加载，否则开始新的数据采集
4. **更新标识**：更新孔ID显示为新的样品标识

### 5. 【查看下一个样品】按钮功能

#### 按钮特性
- **位置**：面板A右侧面板中，异常监控窗口下方
- **样式**：绿色背景，白色文字，加粗显示
- **尺寸**：适中大小，易于点击

#### 功能流程
1. 点击按钮 → 触发`view_next_sample()`方法
2. 保存当前样品数据到历史记录
3. 样品索引递增（Sample_0 → Sample_1 → Sample_2...）
4. 清除当前显示的数据和异常列表
5. 更新状态显示为新的样品ID
6. 准备接收新样品的数据

## 技术实现细节

### 1. 布局修改
```python
# 改为垂直分割器
splitter = QSplitter(Qt.Vertical)

# 面板A使用水平布局：图表在左，异常窗口在右
panel_a_layout = QHBoxLayout(panel_a)
```

### 2. 异常监控组件
```python
def create_anomaly_panel(self, parent_layout):
    # 创建固定宽度的异常监控面板
    anomaly_widget = QGroupBox("异常直径监控")
    anomaly_widget.setFixedWidth(280)  # 右侧布局，稍微增加宽度
    # ... 详细实现
```

### 3. 数据更新增强
```python
def update_data(self, depth, diameter):
    # 原有功能
    self.depth_data.append(depth)
    self.diameter_data.append(diameter)
    
    # 新增功能
    self.check_anomaly(depth, diameter)        # 异常检测
    self.save_current_sample_data(depth, diameter)  # 数据保存
    # ... 图表更新
```

## 使用说明

### 1. 启动程序
```bash
python main.py
```

### 2. 进入实时监控页面
- 在主检测视图中点击正在检测的孔（黄色）
- 或直接切换到"实时监控"选项卡

### 3. 观察新功能
- **异常监控**：右侧窗口会实时显示超出公差的测量点
- **样品切换**：点击【查看下一个样品】按钮切换到新样品
- **布局变化**：面板A在上，面板B在下的新布局

### 4. 测试演示
```bash
# 运行专门的演示程序
python demo_ui_changes.py

# 运行布局修正测试
python test_right_panel_layout.py
```

## 测试验证

### 1. 功能测试
- ✅ 异常检测：自动识别超出公差的数据点
- ✅ 异常显示：实时更新异常列表和统计
- ✅ 样品切换：正确保存和加载样品数据
- ✅ 布局调整：面板A和B正确的上下布局

### 2. 性能测试
- ✅ 实时性：高频数据下UI保持流畅
- ✅ 内存管理：异常数据列表自动限制显示数量
- ✅ 数据完整性：样品切换时数据正确保存和恢复

### 3. 用户体验测试
- ✅ 界面直观：异常数据一目了然
- ✅ 操作简便：一键切换样品
- ✅ 信息完整：异常统计信息清晰显示

## 兼容性说明

### 保持的原有功能
- ✅ 光谱共焦传感器实时折线图
- ✅ 公差上下限标示线
- ✅ 内窥镜实时图像显示
- ✅ 状态指示器（孔ID、深度、通信状态）
- ✅ 多线程数据处理架构
- ✅ 数据缓冲和性能优化

### 增强的功能
- ✅ 异常数据自动检测和显示
- ✅ 样品数据管理和历史记录
- ✅ 更直观的上下布局设计
- ✅ 实时异常统计分析

## 后续扩展建议

1. **异常分析**：可以添加异常数据的趋势分析
2. **报警功能**：异常率超过阈值时的声音或视觉报警
3. **数据导出**：支持导出特定样品的异常数据报告
4. **样品标识**：支持自定义样品名称而不是自动编号

---

**修改完成时间**：2024年当前时间  
**修改状态**：✅ 已完成并测试通过  
**影响范围**：仅限二级【实时监控】界面，其他功能保持不变
