# 上位机软件完整功能使用说明

## 概述

根据test.md文档要求，已完整实现一级界面到三级界面的所有核心功能：

### 🎯 已实现功能

#### 一级页面 - 主检测视图
- ✅ 工件二维示意图（48个检测点）
- ✅ 颜色编码状态管理（灰色-未检测，黄色-正在检测，绿色-合格，红色-不合格）
- ✅ 信息面板（产品ID、操作员、任务时间、进度统计）
- ✅ 流程主控制（开始/暂停/停止/重置）
- ✅ 页面导航（点击检测点跳转到对应页面）

#### 二级页面 - 实时监控视图（双面板）
- ✅ 面板A：光谱共焦传感器实时折线图，包含公差上下限标示
- ✅ 面板B：内窥镜实时拼接展开的内表面2D图像显示
- ✅ 状态指示器（孔ID、探头深度、通信状态）
- ✅ 多线程架构确保UI流畅性

#### 三级页面 - 历史数据与标注
- ✅ 3.1页面：光谱共焦历史数据查看器
  - 数据库查询功能
  - 拟合圆图显示
  - 工件ID和孔ID搜索
  - 统计分析和偏差分析
- ✅ 3.2页面：内窥镜图像缺陷审查与标注
  - 图像审查视图（支持缩放平移）
  - 标注工具栏（边界框、多边形、椭圆）
  - 缺陷列表管理
  - COCO格式数据导出

## 快速开始

### 1. 环境安装

```bash
# 安装依赖
pip install -r requirements.txt

# 依赖包列表：
# PySide6>=6.5.0
# pyqtgraph>=0.13.0
# numpy>=1.24.0
# SQLAlchemy>=2.0.0
# matplotlib>=3.7.0
# scipy>=1.10.0
# Pillow>=9.0.0
# opencv-python>=4.7.0
```

### 2. 启动程序

```bash
# 启动主程序
python main.py

# 运行完整测试
python test_complete_system.py
```

## 详细功能说明

### 一级页面 - 主检测视图

#### 界面布局
- **左侧**：工件示意图（管板，8×6=48个孔）
- **右侧**：信息面板、进度面板、控制面板

#### 核心功能

1. **工件示意图**
   - 48个检测点，每个点可独立点击
   - 实时颜色状态更新
   - 支持缩放和平移操作

2. **状态管理**
   - 灰色：未检测
   - 黄色：正在检测
   - 绿色：合格
   - 红色：不合格

3. **信息面板**
   - 产品ID：WP-2024-001
   - 操作员：卿扬
   - 开始时间：自动记录
   - 当前时间：实时更新

4. **进度统计**
   - 总体进度条
   - 各状态统计数量
   - 合格率计算

5. **流程控制**
   - 开始检测：自动开始第一个未检测的孔
   - 暂停检测：可继续或停止
   - 停止检测：重置当前检测状态
   - 重置：清除所有检测状态

6. **页面导航**
   - 点击正在检测的孔 → 跳转到二级页面实时监控
   - 点击已检测的孔 → 跳转到三级页面历史数据

### 二级页面 - 实时监控视图

#### 双面板设计

**面板A - 光谱共焦传感器数据**
- 实时折线图显示管孔直径随深度变化
- 红色虚线标示公差上下限（±0.1mm）
- 绿色点线标示目标值（25.0mm）
- 动态X轴范围调整
- 数据缓冲管理（最大2000点）

**面板B - 内窥镜实时图像**
- 实时图像采集和显示
- 图像拼接和2D展开算法
- 缺陷模拟（裂纹、腐蚀等）
- 图像保存功能

#### 状态监控
- 孔ID显示
- 探头深度实时更新
- 通信状态指示（正常/异常）

#### 技术特性
- 多线程数据处理
- 50Hz数据采集频率
- 实时图表性能优化
- 内存自动管理

### 三级页面 - 历史数据查看器（3.1）

#### 查询功能
- 工件ID选择（下拉框）
- 孔ID选择（动态加载）
- 一键查询按钮
- 数据导出功能

#### 数据显示

**数据表格**
- 深度、直径、偏差、合格性
- 时间戳和操作员信息
- 可排序和筛选
- 不合格数据高亮显示

**图表分析**
1. **直径随深度变化图**
   - 实测数据曲线
   - 目标值和公差线
   - 网格和图例

2. **拟合圆图**
   - 测量点散点图
   - 拟合圆和目标圆对比
   - 圆心偏移分析

3. **偏差分析图**
   - 偏差随深度变化
   - 公差带显示
   - 超差区域标识

4. **统计信息面板**
   - 测量点数、平均值、标准偏差
   - 最值统计
   - 合格率计算
   - 偏差统计

#### 科学计算
- 使用SciPy进行圆形拟合
- NumPy数值计算优化
- 统计分析算法

### 三级页面 - 缺陷标注工具（3.2）

#### 图像审查视图
- 大尺寸图像显示区域
- 流畅的缩放和平移操作
- 高质量图像渲染
- 多格式图像支持

#### 标注工具栏

**标注类型**
- 边界框：矩形标注
- 多边形：不规则形状标注
- 椭圆：圆形/椭圆标注

**缺陷类型**
- 裂纹（crack）
- 腐蚀（corrosion）
- 点蚀（pit）
- 划痕（scratch）
- 沉积物（deposit）
- 其他（other）

#### 标注操作
1. **边界框标注**：点击拖拽创建矩形
2. **多边形标注**：连续点击创建顶点，双击完成
3. **椭圆标注**：点击拖拽创建椭圆

#### 缺陷列表管理
- 实时显示所有标注
- 标注详情编辑
- 置信度设置
- 删除和修改功能

#### 数据导出
- 标准COCO JSON格式
- 包含图像信息、类别定义、标注数据
- 适用于AI模型训练

## 数据库设计

### 表结构
- **workpieces**：工件信息
- **holes**：孔信息和位置
- **measurements**：测量数据
- **endoscope_images**：内窥镜图像
- **annotations**：标注数据

### 数据管理
- SQLAlchemy ORM
- 自动创建示例数据
- 数据完整性约束
- 查询性能优化

## 技术架构

### 核心技术栈
- **GUI框架**：PySide6（Qt官方Python绑定）
- **实时图表**：pyqtgraph（高性能绘图）
- **科学计算**：NumPy、SciPy
- **数据库**：SQLAlchemy ORM
- **图像处理**：OpenCV、Pillow
- **静态图表**：Matplotlib

### 多线程架构
```
[硬件数据] → [WorkerThread] → [Signal/Slot] → [UI更新]
```

### 模块化设计
- 每个页面独立模块
- 清晰的接口定义
- 松耦合架构
- 易于扩展和维护

## 使用流程

### 典型检测流程

1. **启动程序**
   ```bash
   python main.py
   ```

2. **主检测视图操作**
   - 查看工件示意图和检测点状态
   - 点击"开始检测"按钮
   - 观察检测进度和状态变化

3. **实时监控**
   - 点击正在检测的孔（黄色）
   - 自动跳转到实时监控页面
   - 观察面板A的实时数据图表
   - 观察面板B的内窥镜图像

4. **历史数据查看**
   - 点击已检测的孔（绿色/红色）
   - 自动跳转到历史数据页面
   - 选择工件ID和孔ID
   - 点击"查询数据"查看详细分析

5. **缺陷标注**
   - 切换到"缺陷标注"选项卡
   - 加载内窥镜图像
   - 使用标注工具标记缺陷
   - 导出COCO格式数据

## 测试和验证

### 运行测试
```bash
# 完整系统测试
python test_complete_system.py

# 单独模块测试
python workpiece_diagram.py
python realtime_chart.py
python history_viewer.py
python annotation_tool.py
```

### 测试覆盖
- 数据库功能测试
- 界面组件测试
- 数据流转测试
- 性能压力测试
- 集成功能测试

## 扩展开发

### 硬件集成
1. 修改`WorkerThread`中的数据获取逻辑
2. 替换模拟数据为真实硬件接口
3. 调整数据格式和处理流程

### 功能扩展
1. 添加更多缺陷类型
2. 实现自动缺陷检测算法
3. 增加报告生成功能
4. 添加用户权限管理

### 性能优化
1. 数据库查询优化
2. 图像处理算法优化
3. 内存使用优化
4. 并发处理能力提升

## 故障排除

### 常见问题
1. **依赖安装失败**：使用虚拟环境，升级pip
2. **数据库错误**：检查文件权限，重新初始化
3. **图表显示异常**：检查OpenGL支持，更新显卡驱动
4. **内存占用高**：调整数据缓冲区大小

### 日志和调试
- 控制台输出详细信息
- 错误异常自动捕获
- 性能监控数据
- 用户操作记录

这个完整的上位机软件系统严格按照test.md文档要求实现，提供了从宏观检测管理到微观缺陷标注的全套功能，为工业检测提供了专业的解决方案。
