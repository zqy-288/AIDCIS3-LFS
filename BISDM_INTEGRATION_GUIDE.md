# 🎯 BISDM集成使用指南

## 概述

成功将BISDM（内窥镜图像处理系统）集成到主检测界面的【开始检测】按钮中，实现了**一键启动视频采集和实时处理**的功能。

## 🚀 功能特性

### 1. **一键操作**
- 点击【开始检测】直接启动内窥镜视频采集
- 按钮自动变为【停止检测】
- 无需切换界面或额外配置

### 2. **实时处理**
- 自动录制原始视频
- 实时选择关键帧
- 边采集边处理，生成全景图

### 3. **智能容错**
- BISDM模块可用时：启用完整视频处理功能
- BISDM模块不可用时：自动切换到模拟模式
- 详细的状态日志显示

### 4. **状态反馈**
- 实时显示处理进度
- 日志面板显示详细信息
- 处理完成自动提示

## 🎮 使用方法

### 1. **启动检测**
```
1. 确保内窥镜设备已连接
2. 点击主界面右侧的【开始检测】按钮
3. 系统自动开始视频采集和处理
4. 按钮变为【停止检测】，显示红色
```

### 2. **监控状态**
```
- 左侧日志面板显示处理状态
- 每2秒更新一次处理进度
- 显示已处理帧数和关键帧数
```

### 3. **停止检测**
```
1. 点击【停止检测】按钮
2. 系统自动生成全景图
3. 保存处理结果
4. 按钮恢复为【开始检测】，显示绿色
```

## 📁 输出结果

处理完成后，在以下位置生成结果：

```
Data/detection_output_YYYYMMDD_HHMMSS/
├── recorded_YYYYMMDD_HHMMSS.mp4    # 原始录制视频
├── 00_keyframes/                    # 选中的关键帧
├── 01_deblurred/                    # 去模糊处理结果  
├── 02_unwrapped/                    # 展开处理结果
├── panorama.png                     # 最终全景图
└── config.json                      # 处理参数配置
```

## ⚙️ 配置参数

系统使用以下默认配置：

```python
# 关键帧选择
enable_keyframe_selection = True    # 启用关键帧选择
keyframe_strategy = "interval"      # 固定间隔策略
keyframe_interval = 30              # 每30帧选择一个关键帧

# 处理选项
save_intermediate = True            # 保存中间处理结果
```

## 🔧 技术实现

### 1. **集成架构**
```
MainDetectionView
├── on_start_detection()           # 开始检测入口
├── _start_bisdm_detection()       # 启动BISDM处理
├── _stop_bisdm_detection()        # 停止并生成结果
├── _update_detection_status()     # 实时状态更新
└── _reset_ui_state()             # 重置界面状态
```

### 2. **关键组件**
- **RealtimeProcessor**: BISDM实时处理器
- **BISDMConfig**: 处理配置管理
- **QTimer**: 状态更新定时器

### 3. **错误处理**
- 摄像头连接检查
- 模块导入异常处理
- 处理过程异常恢复

## 📊 日志信息说明

### 正常流程日志：
```
[12:34:56] 启动内窥镜视频采集...
[12:34:57] 视频采集已启动，正在处理...
[12:34:57] 输出目录: Data/detection_output_20250721_123456
[12:34:59] 处理状态: 60 帧, 关键帧: 2
[12:35:10] 正在停止检测并生成全景图...
[12:35:15] 正在生成全景图，请稍候...
[12:35:20] 全景图生成完成！
[12:35:20] 结果保存在: Data/detection_output_20250721_123456
```

### 模拟模式日志：
```
[12:34:56] BISDM模块不可用，启动模拟检测...
[12:34:57] 模拟处理中... 1 秒
[12:35:06] 模拟检测完成！
```

## 🛠️ 故障排除

### 1. **摄像头无法打开**
```
错误: "启动视频采集失败！请检查摄像头连接"
解决: 
- 检查摄像头是否正确连接
- 确认摄像头未被其他程序占用
- 尝试更换USB端口
```

### 2. **BISDM模块不可用**
```
提示: "BISDM模块不可用，启动模拟检测..."
说明: 
- 系统自动切换到模拟模式
- 基本功能仍可正常使用
- 不影响主界面操作
```

### 3. **处理异常中断**
```
- 点击【停止检测】或【重置】按钮
- 系统会自动清理资源
- 重新启动检测即可
```

## 🎯 使用建议

### 1. **最佳实践**
- 检测前确保内窥镜设备正常工作
- 保持稳定的光照条件
- 避免频繁启动/停止操作

### 2. **性能优化**
- 关键帧间隔可根据需要调整（默认30帧）
- 处理过程中避免运行其他大型程序
- 定期清理输出目录释放磁盘空间

### 3. **结果分析**
- 查看panorama.png获得完整全景图
- 检查关键帧目录了解采集质量
- 原始视频可用于回放分析

## 📞 技术支持

如遇到问题，请检查：
1. 控制台输出的错误信息
2. 日志面板的详细状态
3. 输出目录的文件生成情况

---

✅ **集成完成！BISDM功能已成功整合到主检测界面中。**